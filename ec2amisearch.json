{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template to deploy a Lambda function with a security group and IAM role.",
  "Parameters": {
    "FunctionName": {
      "Description": "Name of the Lambda function.",
      "Type": "String"
    },
    "Subnet": {
      "Description": "Subnet in which the Lambda function will be deployed.",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "VPC": {
      "Description": "VPC in which the Lambda function will be deployed.",
      "Type": "AWS::EC2::VPC::Id"
    },
    "SourceCodeBucket": {
      "Description": "S3 bucket containing the source code for the Lambda function.",
      "Type": "String"
    },
    "S3Key": {
      "Description": "S3 key for the source code zip of the Lambda function.",
      "Type": "String"
    },
		  "snsalerttopic": {
    "Description": "ARN of the SNS topic for alerts",
    "Type": "String"
  }
  },
  "Resources": {
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }]
        },
        "Policies": [{
          "PolicyName": "LambdaExecutionPolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents",
                  "ec2:DescribeInstances",
                  "cloudwatch:GetMetricData",
                  "sns:Publish",
                  "ec2:DescribeImages"
                ],
                "Resource": "*"
              }
            ]
          }
        }]
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Security Group for Lambda Function"
      }
    },
"LambdaFunction": {
  "Type": "AWS::Lambda::Function",
  "Properties": {
    "FunctionName": {
      "Ref": "FunctionName"
    },
    "Handler": "index.handler",
    "Role": {
      "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]
    },
    "Code": {
      "S3Bucket": {
        "Ref": "SourceCodeBucket"
      },
      "S3Key": {
        "Ref": "S3Key"
      }
    },
    "Runtime": "python3.8",
    "Timeout": 300,
"Environment": {
  "Variables": {
    "SNS_TOPIC_ARN": {
      "Ref": "snsalerttopic"
    }
  }
},
    "VpcConfig": {
      "SecurityGroupIds": [{
        "Ref": "LambdaSecurityGroup"
      }],
      "SubnetIds": [{
        "Ref": "Subnet"
      }]
    }
  }
}

  }
}
